// Run: terser smart-print.js -c -m -o smart-print.min.js
// Or use this minified version:

!function(){"use strict";const e=(window.QZ_CONFIG&&window.QZ_CONFIG.endpoint)||"/qz",t={connected:!1,printers:[],settings:{autoConnect:!0,rememberPrinters:!0,showNotifications:!0,fallbackToBrowser:!0,enableHotkey:!0,cachePrinters:!0,debugMode:!1},printQueue:[],isProcessing:!1,currentJob:null,eventListeners:new Map};function n(...e){(window.QZ_CONFIG&&window.QZ_CONFIG.debug||t.settings.debugMode)&&console.log("[Smart-Print]",...e)}function o(...e){console.error("[Smart-Print]",...e)}function r(...e){console.warn("[Smart-Print]",...e)}function s(e,n={}){const o=new CustomEvent(`smartprint:${e}`,{detail:n});document.dispatchEvent(o),t.eventListeners.has(e)&&t.eventListeners.get(e).forEach(t=>{try{t(n)}catch(e){o("Event listener error:",e)}}),n(`Event emitted: ${e}`,n)}async function i(){return new Promise((e,t)=>{if("undefined"!=typeof qz&&qz.security)return e();let n=0,o=setInterval((()=>{if(n++,"undefined"!=typeof qz&&qz.security)clearInterval(o),e();else if(n>=50)clearInterval(o),t(new Error("QZ Tray library not loaded"))}),100)})}function c(){qz.security.setCertificatePromise((()=>new Promise((t,n)=>{const o=localStorage.getItem("qz_certificate_v2");o?(n("Using cached certificate"),t(o)):(n("Fetching certificate from server"),fetch(`${e}/certificate`).then(e=>{if(!e.ok)throw new Error(`Certificate request failed: ${e.status}`);return e.text()}).then(e=>{localStorage.setItem("qz_certificate_v2",e),t(e)}).catch(e=>{n(new Error(`Failed to load certificate: ${e.message}`))}))})),qz.security.setSignaturePromise((t=>new Promise((n,o)=>{n("Requesting signature"),fetch(`${e}/sign`,{method:"POST",headers:{"Content-Type":"application/json","X-Requested-With":"XMLHttpRequest"},body:JSON.stringify({data:t})}).then(e=>{if(!e.ok)throw new Error(`Signature request failed: ${e.status}`);return e.text()}).then(e=>n(e)).catch(e=>{o(new Error(`Failed to get signature: ${e.message}`))})})))}async function a(){if(t.connected)return n("Already connected"),!0;s("connecting");try{return n("Connecting to QZ Tray..."),await qz.websocket.connect({retries:3,delay:1e3,timeout:1e4}),t.connected=!0,s("connected"),n("Connected to QZ Tray"),!0}catch(e){return s("connection-failed",{error:e.message}),o("Connection failed:",e.message),!1}}async function l(){if(t.settings.cachePrinters){const e=localStorage.getItem("qz_printers_v2");if(e)try{const n=JSON.parse(e);if(Date.now()-n.timestamp<3e5)return t.printers=n.printers,n("Loaded printers from cache:",t.printers.length),t.printers}catch(e){}}try{n("Fetching printers from server...");const n=await fetch(`${e}/printers`);if(!n.ok)throw new Error(`Failed to fetch printers: ${n.status}`);const o=await n.json();if(o.success&&o.printers){if(t.printers=Array.isArray(o.printers)?o.printers:[],t.settings.cachePrinters){const n={printers:t.printers,timestamp:Date.now()};localStorage.setItem("qz_printers_v2",JSON.stringify(n))}return s("printers-loaded",{printers:t.printers,cached:!1}),n("Printers loaded from server:",t.printers.length),t.printers}return[]}catch(e){if(s("printers-error",{error:e.message}),o("Failed to load printers:",e),t.connected)try{const e=await qz.printers.find();if(e&&e.length>0)return t.printers=e,t.printers}catch(e){}return[]}}async function d(n=window.location.pathname){const o=document.activeElement;if(o&&o.dataset&&o.dataset.qzPrinter)return o.dataset.qzPrinter;if(t.settings.rememberPrinters){const o=JSON.parse(localStorage.getItem("qz_printer_map_v2")||"{}");if(o[n])return o[n];for(const[t,r]of Object.entries(o))if(t.endsWith("/*")&&n.startsWith(t.slice(0,-2)))return r}try{const o=await fetch(`${e}/printer${encodeURIComponent(n)}`);if(o.ok){const e=await o.json();if(e.success&&e.printer)return e.printer}}catch(e){n("Failed to get printer from server:",e.message)}if(t.connected)try{const e=await qz.printers.find();if(e&&e.length>0){const t=await qz.printers.getDefault();return t||e[0]}}catch(e){o("Failed to get default printer:",e)}return null}async function u(o,r=window.location.pathname){if(!o)return;t.settings.rememberPrinters&&function(o,r){const s=JSON.parse(localStorage.getItem("qz_printer_map_v2")||"{}");s[r]=o,localStorage.setItem("qz_printer_map_v2",JSON.stringify(s))}(o,r);try{await fetch(`${e}/printer`,{method:"POST",headers:{"Content-Type":"application/json","X-Requested-With":"XMLHttpRequest"},body:JSON.stringify({printer:o,path:r})})}catch(e){r("Failed to save printer to server:",e)}s("printer-saved",{path:r,printer:o}),n(`Printer "${o}" saved for path "${r}"`)}function p(e){return new Promise((t,n)=>{const o=new FileReader;o.onloadend=()=>t(o.result.split(",")[1]),o.onerror=n,o.readAsDataURL(e)})}async function m(t,o=1){const r=new AbortController,i=setTimeout((()=>r.abort()),3e4);try{n(`Fetching PDF from: ${t} (attempt ${o})`);const a={Accept:"application/pdf, */*","X-Requested-With":"XMLHttpRequest","X-Print-Request":"true","X-Print-Attempt":o.toString()},l=document.querySelector('meta[name="csrf-token"]');l&&(a["X-CSRF-TOKEN"]=l.getAttribute("content"));const d=await fetch(t,{headers:a,credentials:"include",signal:r.signal});clearTimeout(i);if(!d.ok)throw new Error(`HTTP ${d.status}: ${d.statusText}`);const u=d.headers.get("content-type")||"",m=d.headers.get("content-disposition")||"",g=u.includes("pdf")||m.includes(".pdf")||m.includes("attachment");if(!g){const e=await d.text();if(!e.includes("%PDF")&&!e.includes("PDF"))throw new Error("Response is not a PDF");n("PDF detected without proper headers");const t=new Blob([e],{type:"application/pdf"});return await p(t)}const g=await d.blob(),f=await p(g);return n(`PDF fetched successfully (${g.size} bytes)`),f}catch(e){throw clearTimeout(i),e.name==="AbortError"?new Error("PDF download timeout"):e}}function g(){const e=document.querySelector('meta[name="csrf-token"]');return e?e.getAttribute("content"):null}async function f(e,o={}){const r="job_"+Date.now()+"_"+Math.random().toString(36).substr(2,9),i=Date.now(),c={id:r,url:e,options:{printer:o.printer||null,type:o.type||"pdf",copies:parseInt(o.copies)||1,rawData:o.rawData||null,...o},status:"queued",path:window.location.pathname,startTime:i,attempts:0};return t.printQueue.push(c),s("job-queued",{job:c}),n(`Job queued: ${r}`),h(),r}async function h(){if(t.isProcessing||0===t.printQueue.length)return;t.isProcessing=!0;for(;t.printQueue.length>0;){const e=t.printQueue.shift();t.currentJob=e,await function(e){e.attempts++,e.status="processing",s("job-processing",{job:e});try{n(`Processing job: ${e.id} (attempt ${e.attempts})`);const o=e.options.printer||await d(e.path);if(!o)throw new Error("No printer selected");const r=qz.configs.create(o);let i;if("zpl"===e.options.type||"escpos"===e.options.type||"raw"===e.options.type)i=[{type:"raw",data:e.options.rawData||e.url,options:{language:"zpl"===e.options.type?"ZPL":"ESC/POS"}}];else{const t=await m(e.url,e.attempts);i=[{type:"pdf",format:"base64",data:t}]}e.options.copies>1&&(i[0].copies=e.options.copies);const c=await qz.print(r,i);e.status="completed",e.endTime=Date.now(),e.duration=e.endTime-e.startTime,e.result=c;try{await fetch(`${e}/print`,{method:"POST",headers:{"Content-Type":"application/json","X-Requested-With":"XMLHttpRequest"},body:JSON.stringify({url:e.url,printer:o,type:e.options.type,copies:e.options.copies,path:e.path,job_id:e.id})})}catch(e){r("Failed to notify server:",e)}s("job-completed",{job:e}),n(`Job completed: ${e.id} in ${e.duration}ms`)}catch(o){e.status="failed",e.error=o.message,e.endTime=Date.now(),e.duration=e.endTime-e.startTime,s("job-failed",{job:e,error:o.message}),o(`Job failed: ${e.id}`,o),e.attempts<3?(n(`Retrying job ${e.id} (attempt ${e.attempts+1})`),t.printQueue.unshift(e),await new Promise(e=>setTimeout(e,1e3*e.attempts))):t.settings.fallbackToBrowser&&function(e){n("Falling back to browser printing");if("pdf"===e.options.type||!e.options.type){const t=window.open(e.url,"_blank");t&&(t.onload=function(){try{t.print()}catch(e){r("Browser print failed:",e)}})}else window.open(e.url,"_blank");s("fallback-print",{job:e})}(e)}}(e)}t.currentJob=null,t.isProcessing=!1}function y(){document.addEventListener("click",(function(n){const o=n.target.closest("[data-qz-print]");if(!o)return;n.preventDefault();const r=o.dataset.qzPrint,i={printer:o.dataset.qzPrinter,type:o.dataset.qzType||"pdf",copies:parseInt(o.dataset.qzCopies)||1};r&&f(r,i)})),t.settings.enableHotkey&&document.addEventListener("keydown",(function(e){e.ctrlKey&&e.shiftKey&&"P"===e.key&&(e.preventDefault(),async function(){if(!t.connected&&!await a())return void(t.settings.showNotifications&&alert("Cannot connect to QZ Tray"));if(0===t.printers.length&&await l(),!t.printers.length)return;const e=await d(),n=t.printers.map((e=>"string"==typeof e?e:e.name||e)).join("\n"),o=prompt(`ðŸ–¨ï¸ Current Printer: ${e||"Not set"}\n\nAvailable Printers:\n${n}\n\nEnter printer name:`,e);if(o){const n=t.printers.some((t=>"string"==typeof t&&t===o||t.name&&t.name===o));n?(await u(o),t.settings.showNotifications&&alert(`âœ… Printer "${o}" saved for this page`)):t.settings.showNotifications&&alert("âŒ Printer not found in available printers")}}())}))}async function v(){if(!t.connected&&!await a())return void(t.settings.showNotifications&&alert("Cannot connect to QZ Tray"));0===t.printers.length&&await l();const e=await d(),n=t.printers.map((e=>"string"==typeof e?e:e.name||e)).join("\n"),o=prompt(`ðŸ–¨ï¸ Current Printer: ${e||"Not set"}\n\nAvailable Printers:\n${n}\n\nEnter printer name:`,e);if(o){const n=t.printers.some((t=>"string"==typeof t&&t===o||t.name&&t.name===o));n?(await u(o),t.settings.showNotifications&&alert(`âœ… Printer "${o}" saved for this page`)):t.settings.showNotifications&&alert("âŒ Printer not found in available printers")}}function b(){try{const e=localStorage.getItem("qz_settings_v2");e&&(t.settings={...t.settings,...JSON.parse(e)})}catch(e){o("Failed to load settings:",e)}}function S(){try{localStorage.setItem("qz_settings_v2",JSON.stringify(t.settings))}catch(e){o("Failed to save settings:",e)}}function w(){document.querySelectorAll("[data-qz-auto-print]").forEach((e=>{const t=e.dataset.qzAutoPrint,n=parseInt(e.dataset.qzDelay)||1e3,o=e.dataset.qzPrinter;t&&setTimeout((()=>{f(t,{printer:o})}),n)}))}const P={print:f,printRaw:function(e,t="zpl",n=null){return f(e,{type:t,printer:n,rawData:e})},printZPL:function(e,t=null){return this.printRaw(e,"zpl",t)},printESC:function(e,t=null){return this.printRaw(e,"escpos",t)},getPrinters:l,getCurrentPrinter:()=>d(),setPrinter:u,showPrinterSwitcher:v,connect:a,disconnect:function(){return t.connected&&qz.websocket?qz.websocket.disconnect().then((()=>(t.connected=!1,s("disconnected")))):Promise.resolve()},isConnected:()=>t.connected,getStatus:function(){return{connected:t.connected,printers:t.printers.length,queueLength:t.printQueue.length,isProcessing:t.isProcessing,currentJob:t.currentJob}},getQueue:()=>[...t.printQueue],clearQueue:function(){t.printQueue=[],s("queue-cleared")},getSettings:()=>({...t.settings}),updateSettings:function(e){return t.settings={...t.settings,...e},S(),s("settings-updated",{settings:t.settings}),t.settings},on:function(e,n){return t.eventListeners.has(e)||t.eventListeners.set(e,[]),t.eventListeners.get(e).push(n),this},off:function(e,n){if(t.eventListeners.has(e)){const o=t.eventListeners.get(e),r=o.indexOf(n);r>-1&&o.splice(r,1)}return this},clearCache:function(){["qz_certificate_v2","qz_printers_v2","qz_printer_map_v2","qz_settings_v2","qz_print_jobs_v2"].forEach((e=>{localStorage.removeItem(e)})),s("cache-cleared"),n("Cache cleared")},version:"2.0.0"};async function x(){try{b(),await i(),c(),y(),t.settings.autoConnect&&await a(),t.connected&&await l(),w(),s("ready",{version:"2.0.0"}),n("Smart-Print initialized successfully")}catch(e){o("Initialization failed:",e),s("init-failed",{error:e.message})}}"loading"===document.readyState?document.addEventListener("DOMContentLoaded",x):x(),window.SmartPrint=P,window.smartPrint=f,window.smartPrintZPL=P.printZPL,window.smartPrintESC=P.printESC}();
