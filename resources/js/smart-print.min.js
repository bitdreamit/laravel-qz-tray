!function(){"use strict";let t={ENDPOINT:window.QZ_CONFIG&&window.QZ_CONFIG.endpoint||"/qz",DEBUG:window.QZ_CONFIG&&window.QZ_CONFIG.debug||!1,VERSION:"2.0.0",CONNECT_TIMEOUT:1e4,PRINT_TIMEOUT:3e4,PDF_TIMEOUT:3e4,MAX_RETRIES:3,RETRY_DELAY:1e3,CERT_CACHE_DURATION:36e5,PRINTER_CACHE_DURATION:3e5,STORAGE_KEYS:{CERTIFICATE:"qz_certificate_v2",PRINTERS:"qz_printers_v2",PRINTER_MAP:"qz_printer_map_v2",SETTINGS:"qz_settings_v2",PRINT_JOBS:"qz_print_jobs_v2"},DEFAULT_SETTINGS:{autoConnect:!0,rememberPrinters:!0,showNotifications:!0,fallbackToBrowser:!0,enableHotkey:!0,cachePrinters:!0,debugMode:!1}},e={connected:!1,printers:[],settings:{...t.DEFAULT_SETTINGS},printQueue:[],isProcessing:!1,currentJob:null,eventListeners:new Map};function n(...n){(t.DEBUG||e.settings.debugMode)&&console.log("[Smart-Print]",...n)}function r(...t){console.error("[Smart-Print]",...t)}function i(...t){console.warn("[Smart-Print]",...t)}function s(t,i={}){let s=`smartprint:${t}`,a=new CustomEvent(s,{detail:i});document.dispatchEvent(a),e.eventListeners.has(t)&&e.eventListeners.get(t).forEach(t=>{try{t(i)}catch(e){r("Event listener error:",e)}}),n(`Event emitted: ${t}`,i)}async function a(){return new Promise((t,e)=>{if("undefined"!=typeof qz&&qz.security){t();return}let n=0,r=setInterval(()=>{n++,"undefined"!=typeof qz&&qz.security?(clearInterval(r),t()):n>=50&&(clearInterval(r),e(Error("QZ Tray library not loaded")))},100)})}async function o(){if(e.connected)return n("Already connected"),!0;s("connecting");try{return n("Connecting to QZ Tray..."),await qz.websocket.connect({retries:3,delay:1e3,timeout:t.CONNECT_TIMEOUT}),e.connected=!0,s("connected"),n("Connected to QZ Tray"),!0}catch(r){return s("connection-failed",{error:r.message}),r("Connection failed:",r.message),!1}}async function c(){if(e.settings.cachePrinters){let r=localStorage.getItem(t.STORAGE_KEYS.PRINTERS);if(r)try{let i=JSON.parse(r);if(Date.now()-i.timestamp<t.PRINTER_CACHE_DURATION)return e.printers=i.printers,n("Loaded printers from cache:",e.printers.length),e.printers}catch(a){}}try{n("Fetching printers from server...");let o=await fetch(`${t.ENDPOINT}/printers`);if(!o.ok)throw Error(`Failed to fetch printers: ${o.status}`);let c=await o.json();if(c.success&&c.printers)return e.printers=Array.isArray(c.printers)?c.printers:[],e.settings.cachePrinters&&localStorage.setItem(t.STORAGE_KEYS.PRINTERS,JSON.stringify({printers:e.printers,timestamp:Date.now()})),s("printers-loaded",{printers:e.printers,cached:!1}),n("Printers loaded from server:",e.printers.length),e.printers;return[]}catch(u){s("printers-error",{error:u.message}),u("Failed to load printers:",u);try{if(e.connected){let p=await qz.printers.find();if(p&&p.length>0)return e.printers=p,e.printers}}catch(l){}return[]}}async function u(i=window.location.pathname){let s=document.activeElement;if(s&&s.dataset&&s.dataset.qzPrinter)return s.dataset.qzPrinter;if(e.settings.rememberPrinters){let a=JSON.parse(localStorage.getItem(t.STORAGE_KEYS.PRINTER_MAP)||"{}");if(a[i])return a[i];for(let[o,c]of Object.entries(a))if(o.endsWith("/*")&&i.startsWith(o.slice(0,-2)))return c}try{let u=await fetch(`${t.ENDPOINT}/printer${encodeURIComponent(i)}`);if(u.ok){let p=await u.json();if(p.success&&p.printer)return p.printer}}catch(l){n("Failed to get printer from server:",l.message)}if(e.connected)try{let d=await qz.printers.find();if(d&&d.length>0){let f=await qz.printers.getDefault();return f||d[0]}}catch(g){r("Failed to get default printer:",g)}return null}async function p(r,a=window.location.pathname){if(r){if(e.settings.rememberPrinters){let o=JSON.parse(localStorage.getItem(t.STORAGE_KEYS.PRINTER_MAP)||"{}");o[a]=r,localStorage.setItem(t.STORAGE_KEYS.PRINTER_MAP,JSON.stringify(o))}try{await fetch(`${t.ENDPOINT}/printer`,{method:"POST",headers:{"Content-Type":"application/json","X-Requested-With":"XMLHttpRequest"},body:JSON.stringify({printer:r,path:a})})}catch(c){i("Failed to save printer to server:",c)}s("printer-saved",{path:a,printer:r}),n(`Printer "${r}" saved for path "${a}"`)}}function l(t){return new Promise((e,n)=>{let r=new FileReader;r.onloadend=()=>{let t=r.result.split(",")[1];e(t)},r.onerror=n,r.readAsDataURL(t)})}async function d(e,r=1){let i=new AbortController,s=setTimeout(()=>i.abort(),t.PDF_TIMEOUT);try{n(`Fetching PDF from: ${e} (attempt ${r})`);let a={Accept:"application/pdf, */*","X-Requested-With":"XMLHttpRequest","X-Print-Request":"true","X-Print-Attempt":r.toString()},o=document.querySelector('meta[name="csrf-token"]');o&&(a["X-CSRF-TOKEN"]=o.getAttribute("content"));let c=await fetch(e,{headers:a,credentials:"include",signal:i.signal});if(clearTimeout(s),!c.ok)throw Error(`HTTP ${c.status}: ${c.statusText}`);let u=c.headers.get("content-type")||"",p=c.headers.get("content-disposition")||"",d=u.includes("pdf")||p.includes(".pdf")||p.includes("attachment");if(!d){let f=await c.text();if(f.includes("%PDF")||f.includes("PDF"))n("PDF detected without proper headers");else throw Error("Response is not a PDF");let g=new Blob([f],{type:"application/pdf"});return await l(g)}let h=await c.blob(),m=await l(h);return n(`PDF fetched successfully (${h.size} bytes)`),m}catch(E){if(clearTimeout(s),"AbortError"===E.name)throw Error("PDF download timeout");throw E}}function f(){let t=document.querySelector('meta[name="csrf-token"]');return t?t.getAttribute("content"):null}async function g(t,r={}){let i="job_"+Date.now()+"_"+Math.random().toString(36).substr(2,9),a=Date.now(),o={id:i,url:t,options:{printer:r.printer||null,type:r.type||"pdf",copies:parseInt(r.copies)||1,rawData:r.rawData||null,...r},status:"queued",path:window.location.pathname,startTime:a,attempts:0};return e.printQueue.push(o),s("job-queued",{job:o}),n(`Job queued: ${i}`),h(),i}async function h(){if(!e.isProcessing&&0!==e.printQueue.length){for(e.isProcessing=!0;e.printQueue.length>0;){let t=e.printQueue.shift();e.currentJob=t,await m(t)}e.currentJob=null,e.isProcessing=!1}}async function m(r){r.attempts++,r.status="processing",s("job-processing",{job:r});try{if(n(`Processing job: ${r.id} (attempt ${r.attempts})`),!e.connected&&!await o())throw Error("Cannot connect to QZ Tray");let a=r.options.printer||await u(r.path);if(!a)throw Error("No printer selected");let c=qz.configs.create(a),p;if("zpl"===r.options.type||"escpos"===r.options.type||"raw"===r.options.type)p=[{type:"raw",data:r.options.rawData||r.url,options:{language:"zpl"===r.options.type?"ZPL":"ESC/POS"}}];else{let l=await d(r.url,r.attempts);p=[{type:"pdf",format:"base64",data:l}]}r.options.copies>1&&(p[0].copies=r.options.copies);let f=await qz.print(c,p);r.status="completed",r.endTime=Date.now(),r.duration=r.endTime-r.startTime,r.result=f;try{await fetch(`${t.ENDPOINT}/print`,{method:"POST",headers:{"Content-Type":"application/json","X-Requested-With":"XMLHttpRequest"},body:JSON.stringify({url:r.url,printer:a,type:r.options.type,copies:r.options.copies,path:r.path,job_id:r.id})})}catch(g){i("Failed to notify server:",g)}s("job-completed",{job:r}),n(`Job completed: ${r.id} in ${r.duration}ms`)}catch(h){r.status="failed",r.error=h.message,r.endTime=Date.now(),r.duration=r.endTime-r.startTime,s("job-failed",{job:r,error:h.message}),h(`Job failed: ${r.id}`,h),r.attempts<t.MAX_RETRIES?(n(`Retrying job ${r.id} (attempt ${r.attempts+1})`),e.printQueue.unshift(r),await new Promise(e=>setTimeout(e,t.RETRY_DELAY*r.attempts))):e.settings.fallbackToBrowser&&function t(e){if(n("Falling back to browser printing"),"pdf"!==e.options.type&&e.options.type)window.open(e.url,"_blank");else{let r=window.open(e.url,"_blank");r&&(r.onload=function(){try{r.print()}catch(t){i("Browser print failed:",t)}})}s("fallback-print",{job:e})}(r)}}async function E(){if(!e.connected&&!await o()){e.settings.showNotifications&&alert("Cannot connect to QZ Tray");return}0===e.printers.length&&await c();let t=await u(),n=e.printers.map(t=>"string"==typeof t?t:t.name||t).join("\n"),r=prompt(`ðŸ–¨ï¸ Current Printer: ${t||"Not set"}

Available Printers:
${n}

Enter printer name:`,t);if(r){let i=e.printers.some(t=>"string"==typeof t&&t===r||t.name&&t.name===r);i?(await p(r),e.settings.showNotifications&&alert(`âœ… Printer "${r}" saved for this page`)):e.settings.showNotifications&&alert("âŒ Printer not found in available printers")}}let T={print:g,printRaw:function(t,e="zpl",n=null){return g(t,{type:e,printer:n,rawData:t})},printZPL:function(t,e=null){return this.printRaw(t,"zpl",e)},printESC:function(t,e=null){return this.printRaw(t,"escpos",e)},getPrinters:c,getCurrentPrinter:()=>u(),setPrinter:p,showPrinterSwitcher:E,connect:o,disconnect:function(){return e.connected&&qz.websocket?qz.websocket.disconnect().then(()=>{e.connected=!1,s("disconnected")}):Promise.resolve()},isConnected:()=>e.connected,getStatus:function(){return{connected:e.connected,printers:e.printers.length,queueLength:e.printQueue.length,isProcessing:e.isProcessing,currentJob:e.currentJob}},getQueue:()=>[...e.printQueue],clearQueue:function(){e.printQueue=[],s("queue-cleared")},getSettings:()=>({...e.settings}),updateSettings:function(n){return e.settings={...e.settings,...n},!function n(){try{localStorage.setItem(t.STORAGE_KEYS.SETTINGS,JSON.stringify(e.settings))}catch(i){r("Failed to save settings:",i)}}(),s("settings-updated",{settings:e.settings}),e.settings},on:function(t,n){return e.eventListeners.has(t)||e.eventListeners.set(t,[]),e.eventListeners.get(t).push(n),this},off:function(t,n){if(e.eventListeners.has(t)){let r=e.eventListeners.get(t),i=r.indexOf(n);i>-1&&r.splice(i,1)}return this},clearCache:function(){Object.values(t.STORAGE_KEYS).forEach(t=>{localStorage.removeItem(t)}),s("cache-cleared"),n("Cache cleared")},version:t.VERSION};async function y(){try{!function n(){try{let i=localStorage.getItem(t.STORAGE_KEYS.SETTINGS);i&&(e.settings={...e.settings,...JSON.parse(i)})}catch(s){r("Failed to load settings:",s)}}(),await a(),qz.security.setCertificatePromise(function(){return new Promise((e,r)=>{let i=localStorage.getItem(t.STORAGE_KEYS.CERTIFICATE);if(i){n("Using cached certificate"),e(i);return}n("Fetching certificate from server"),fetch(`${t.ENDPOINT}/certificate`).then(t=>{if(!t.ok)throw Error(`Certificate request failed: ${t.status}`);return t.text()}).then(n=>{localStorage.setItem(t.STORAGE_KEYS.CERTIFICATE,n),e(n)}).catch(t=>{r(Error(`Failed to load certificate: ${t.message}`))})})}),qz.security.setSignaturePromise(function(e){return new Promise((r,i)=>{n("Requesting signature"),fetch(`${t.ENDPOINT}/sign`,{method:"POST",headers:{"Content-Type":"application/json","X-Requested-With":"XMLHttpRequest"},body:JSON.stringify({data:e})}).then(t=>{if(!t.ok)throw Error(`Signature request failed: ${t.status}`);return t.text()}).then(t=>{r(t)}).catch(t=>{i(Error(`Failed to get signature: ${t.message}`))})})}),document.addEventListener("click",function(t){let e=t.target.closest("[data-qz-print]");if(!e)return;t.preventDefault();let n=e.dataset.qzPrint,r={printer:e.dataset.qzPrinter,type:e.dataset.qzType||"pdf",copies:parseInt(e.dataset.qzCopies)||1};n&&g(n,r)}),e.settings.enableHotkey&&document.addEventListener("keydown",function(t){t.ctrlKey&&t.shiftKey&&"P"===t.key&&(t.preventDefault(),E())}),e.settings.autoConnect&&await o(),e.connected&&await c(),function t(){let e=document.querySelectorAll("[data-qz-auto-print]");e.forEach(t=>{let e=t.dataset.qzAutoPrint,n=parseInt(t.dataset.qzDelay)||1e3,r=t.dataset.qzPrinter;e&&setTimeout(()=>{g(e,{printer:r})},n)})}(),s("ready",{version:t.VERSION}),n("Smart-Print initialized successfully")}catch(i){i("Initialization failed:",i),s("init-failed",{error:i.message})}}"loading"===document.readyState?document.addEventListener("DOMContentLoaded",y):y(),window.SmartPrint=T,window.smartPrint=g,window.smartPrintZPL=T.printZPL,window.smartPrintESC=T.printESC}();
